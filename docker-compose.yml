version: '3.8'

services:
  ipzy-ai:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ipzy-ai
    ports:
      - "${AI_SERVER_PORT:-8000}:8000"
    environment:
      # AI Service Configuration
      - PROJECT_NAME=${PROJECT_NAME:-Fashion Coordination AI}
      - API_PREFIX=${API_PREFIX:-/api}

      # Database (Java 백엔드의 postgres 컨테이너에 연결)
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}

      # API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Backend Integration
      - BACKEND_API_URL=${BACKEND_API_URL:-http://ipzy-app:8080}
      - BACKEND_API_KEY=${BACKEND_API_KEY}

      # ChromaDB
      - VECTOR_DB_PATH=${VECTOR_DB_PATH:-./data/vector_db}
      - CHROMA_COLLECTION_NAME=${CHROMA_COLLECTION_NAME:-fashion_products}

      # Image Processing
      - IMAGE_OUTPUT_DIR=${IMAGE_OUTPUT_DIR:-./outputs/composites}

      # AWS S3 (credentials는 ~/.aws 볼륨 마운트로 사용)
      - AWS_S3_BUCKET=${AWS_S3_BUCKET}
      - AWS_REGION=${AWS_REGION:-ap-northeast-2}
      - S3_IMAGE_PREFIX=${S3_IMAGE_PREFIX:-background-removed}
      - S3_COMPOSITE_PREFIX=${S3_COMPOSITE_PREFIX:-composite}

      # AI Settings
      - MAX_RECOMMENDATIONS=${MAX_RECOMMENDATIONS:-3}
      - MAX_PRODUCTS_PER_CATEGORY=${MAX_PRODUCTS_PER_CATEGORY:-5}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LLM_MODEL=${LLM_MODEL:-gpt-3.5-turbo}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    volumes:
      - ./app:/app/app              # 소스 코드 실시간 반영 (개발용)
      - ai_data:/app/data
      - ai_outputs:/app/outputs
      - ~/.aws:/root/.aws:ro        # AWS credentials (aws configure 사용 시)

    networks:
      - ipzy-network

    restart: on-failure

networks:
  ipzy-network:
    external: true

volumes:
  ai_data:
  ai_outputs:
